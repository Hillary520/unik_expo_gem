{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
<style>
.markdown-body {
    box-sizing: border-box;
    min-width: 200px;
    max-width: 980px;
    margin: 0 auto;
    padding: 45px;
    background-color: rgb(254, 240, 215);
    color: black;
}
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.analysis-section {
    font-size: 16px;
    line-height: 1.6;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0">
            <i class="fas fa-chart-bar me-2"></i>Topic Analysis
        </h2>
        <div class="btn-group">
            <button onclick="exportToPDF('analysis')" class="btn btn-primary">
                <i class="fas fa-file-pdf me-2"></i>Export PDF
            </button>
            <button onclick="location.reload()" class="btn btn-outline-secondary">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4 slide-up">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Questionnaires</h6>
                    <h3 class="mb-0">{{ questionnaire_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 slide-up" style="animation-delay: 0.1s;">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Interviews</h6>
                    <h3 class="mb-0">{{ interview_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 slide-up" style="animation-delay: 0.2s;">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Responses</h6>
                    <h3 class="mb-0" id="totalResponses">{{ total_responses }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 1000;">
        <div class="bg-white p-4 rounded-3 shadow-lg text-center">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p class="mb-0">Generating Analysis...</p>
        </div>
    </div>

    <!-- Analysis Results -->
    <div class="card border-0 shadow-sm slide-up" style="animation-delay: 0.3s;">
        <div class="card-body">
            <div id="analysisResults" class="markdown-body">
                <!-- Analysis content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
    // Add jsPDF initialization
    window.jsPDF = window.jspdf.jsPDF;

    document.addEventListener('DOMContentLoaded', function() {
        loadAnalysis();
    });

    marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: true,
        sanitize: false
    });

    async function loadAnalysis() {
        const spinner = document.getElementById('loadingSpinner');
        const resultsDiv = document.getElementById('analysisResults');
        
        try {
            spinner.style.display = 'block';
            
            const response = await fetch(window.location.href, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            resultsDiv.innerHTML = marked.parse(data.analysis);
            
            // Add classes to tables for Bootstrap styling
            resultsDiv.querySelectorAll('table').forEach(table => {
                table.classList.add('table', 'table-striped', 'table-bordered');
            });
        } catch (error) {
            console.error('Failed to load analysis:', error);
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load analysis. Please try again.
                </div>
            `;
        } finally {
            spinner.style.display = 'none';
        }
    }

    // Update PDF export function
    async function exportToPDF(itemType) {
        try {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'position-fixed top-50 start-50 translate-middle';
            loadingDiv.innerHTML = `
                <div class="bg-white p-4 rounded-3 shadow-lg text-center">
                    <div class="spinner-border text-primary mb-3"></div>
                    <p class="mb-0">Generating PDF...</p>
                </div>
            `;
            document.body.appendChild(loadingDiv);

            // Clone the element to avoid modifying the original
            const element = document.getElementById('analysisResults');
            // set element background to white
            element.style.background = 'white';
            const clone = element.cloneNode(true);
            
            // Create temporary container with white background
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.background = 'white';
            container.style.width = element.offsetWidth + 'px';
            container.appendChild(clone);
            document.body.appendChild(container);

            const canvas = await html2canvas(container, {
                scale: 2, // Higher quality
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight
            });

            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'a4'
            });

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;

            let heightLeft = imgHeight;
            let position = 0;
            let page = 1;

            // First page
            pdf.addImage(imgData, 'JPEG', 0, position, pageWidth, (imgHeight * pageWidth) / imgWidth);
            heightLeft -= pageHeight;

            // Additional pages if needed
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, pageWidth, (imgHeight * pageWidth) / imgWidth);
                heightLeft -= pageHeight;
                page++;
            }

            pdf.save(`${itemType}_analysis_${new Date().toISOString().slice(0,10)}.pdf`);
            
            // Cleanup
            container.remove();
            loadingDiv.remove();
            element.style.background = 'rgb(254, 240, 215)';

        } catch (error) {
            console.error('PDF export failed:', error);
            alert(`Failed to export PDF: ${error.message}`);
        } finally {
            document.querySelector('.position-fixed')?.remove();
            loadingDiv.remove();
        }
    }
</script>
{% endblock %}